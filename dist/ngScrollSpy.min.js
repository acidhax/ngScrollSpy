/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(t){"use strict";function n(){return e}var o=t.module("ngScrollSpy",[]);o.service("ScrollSpy",["$window",function(n){var o,e=function(t){var n={width:t.innerWidth,height:t.innerHeight,maxWidth:t.document.body.scrollWidth,maxHeight:t.document.body.scrollHeight,posX:t.scrollX,posY:t.scrollY};return n.posX<0?(n.posX=0,n.overscrollLeft=!0):n.posX+n.width>n.maxWidth&&(n.posX=n.maxWidth-n.width,n.overscrollRight=!0),n.posY<0?(n.posY=0,n.overscrollTop=!0):n.posY+n.height>n.maxHeight&&(n.posY=n.maxHeight-n.height,n.overscrollBottom=!0),n.hasOverscroll=n.overscrollTop||n.overscrollBottom||n.overscrollLeft||n.overscrollRight,n},r=function(n,o){if(!n||!o)return t.extend({isEqual:!1,velocityX:0,velocityY:0},o);var e={posX:o.posX-n.posX,posY:o.posY-n.posY,width:o.width-n.width,height:o.height-n.height,maxWidth:o.maxWidth-n.maxWidth,maxHeight:o.maxHeight-n.maxHeight};return e.overscrollTop=o.overscrollTop,e.overscrollBottom=o.overscrollBottom,e.overscrollLeft=o.overscrollLeft,e.overscrollRight=o.overscrollRight,e.hasOverscroll=o.hasOverscroll,o.width>0&&(e.velocityX=e.posX/o.width),o.height>0&&(e.velocityY=e.posY/o.height),e.isEqual=!(0!==e.posX||0!==e.posY||0!==e.width||0!==e.height||0!==e.maxWidth||0!==e.maxHeight),e},i={},l=function(t){var l=e(n),s=r(o,l);if(!s.isEqual||s.hasOverscroll||t){for(var c in i){var u=i[c].cond;(u(l,s)||t)&&i[c].handler(l,s)}o=l}};t.element(n).on("scroll",l);var s=this,c=0;this.trigger=function(){this.isForced=!0,l(!0),this.isForced=!1},this.addHandler=function(t,n){return i[c]={cond:t,handler:n},c++,c-1},this.removeHandler=function(t){delete i[t]},this.onScroll=function(t){return s.addHandler(function(){return!0},function(n,o){t(n,o)})},this.onXScroll=function(t){return s.addHandler(function(t,n){return 0!==n.posX},function(n,o){t(n.posX,o.posX,n,o)})},this.onYScroll=function(t){return s.addHandler(function(t,n){return 0!==n.posY},function(n,o){t(n.posY,o.posY,n,o)})},this.onOverscrollHorz=function(t){return s.addHandler(function(t,n){return n.overscrollLeft||n.overscrollRight},t)},this.onOverscrollLeft=function(t){return s.addHandler(function(t,n){return n.overscrollLeft},t)},this.onOverscrollRight=function(t){return s.addHandler(function(t,n){return n.overscrollRight},t)},this.onOverscrollVert=function(t){return s.addHandler(function(t,n){return n.overscrollTop||n.overscrollBottom},t)},this.onOverscrollTop=function(t){return s.addHandler(function(t,n){return n.overscrollTop},t)},this.onOverscrollBottom=function(t){return s.addHandler(function(t,n){return n.overscrollBottom},t)}}]),o.directive("affix",["ScrollSpy",function(t){var n,o=function(t,n,o,e){var r=t(e[0].getBoundingClientRect());r!==n&&(r?e.addClass(o):e.removeClass(o))},e=function(e,r,i){var l,s=!1,c=!1,u=!1;"top"===e?n=t.onYScroll(function(t){c=s,o(function(n){return s?s=t>=l:n.top<=0?(l=n.top<0?t+n.top:t,s=!0):!1},c,r,i)}):"bottom"===e?(u=!0,n=t.onYScroll(function(n,e,u){c=s,o(function(o){return s?s=l>=n:o.bottom>=u.height?(l=t.isForced&&0===n?n+o.bottom-u.height-o.height:n+o.bottom-u.height,s=!0):!1},c,r,i)})):"left"===e?n=t.onXScroll(function(t){c=s,o(function(n){return s?s=t>=l:n.left<=0?(l=n.left<0?t+n.left:t,s=!0):!1},c,r,i)}):"right"===e&&(u=!0,n=t.onXScroll(function(n,e,u){c=s,o(function(o){return s?s=l>=n:o.right>=u.width?(l=t.isForced&&0===n?n+o.right-u.width-o.width:n+o.right-u.width,s=!0):!1},c,r,i)})),u&&t.trigger()};return{restrict:"A",scope:{affix:"@",affixClass:"@"},link:function(o,r){o.affix=o.affix||"top",o.affixClass=o.affixClass||"affix",e(o.affix,o.affixClass,r),o.$on("destroy",function(){t.removeHandler(n)})}}}]);var e={onRun:null,state:null,store:function(t){for(var n in t)this[n]=t[n];this.state=!0,this.run()},builder:null,setBuilder:function(t){this.builder=t,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.builder=null,this.state=null,this.onRun&&(this.onRun(),this.onRun=null))}};o.directive("pageitems",["ScrollSpy",function(o){var e=function(e,r){if(t.isDefined(e.selector)){e.spyElems=r[0].getElementsByClassName(e.selector),e.spies={},n().onRun=function(){e.spies[e.spyElems[0].id].set()},n().store({topMargin:function(){return 0|e.topmargin},addSpy:function(t){e.spies[t.id]=t},getSpy:function(t){return e.spies[t]},items:function(){return e.spyElems}});var i=e.spyElems,l=0|e.topmargin;o.onYScroll(function(t,n,o){for(var r=null,s=e.spies,c=0;c<i.length;c++){var u=i[c],a=s[u.id];if(a.clear(),void 0!==u.getBoundingClientRect().top){var h=u.getBoundingClientRect().top;l>=h?(a.pos=h,null===r&&(r=a),r.pos<a.pos&&(r=a)):null===r&&(r=a)}}o.height+t>=o.maxHeight&&(r=s[i[i.length-1].id]),r.set()})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:e}}]),o.directive("pagemenu",["$compile","$location","$anchorScroll",function(t,o,e){var r=function(r,i){for(var l,s=[],c=[],u=function(t){for(var n={link:t.id,text:t.innerText,parent:""},o=t.tagName,e=0;e<t.classList.length;e++)o+=","+t.classList[e];var r=s.length;if(0===r)s.push(o);else if(o!==s[r-1]){for(var i=r-1;i>=0&&o!=s[i];i--);if(0>i)s.push(o),n.push=!0,c.push(l);else for(n.pop=r-1-i;s.length>i+1;)s.pop(),c.pop()}return c.length>0&&(n.parent=c[c.length-1]),l=n.link,n},a=n().items(),h="",f=0;f<a.length;f++){var p=u(a[f]);if(p.push)h+='<menu class="nav">';else if(p.pop)for(var d=0;d<p.pop;d++)h+="</li></menu>";else 0!==f&&(h+="</li>");h+='<li pagemenuspy="'+p.link+'" parent="'+p.parent+'">',h+='<a href="#'+p.link+'">',h+=p.text,h+="</a>"}h+="</li>",i.append(t(h)(r)),i.on("click",function(t){var r=t.target.hash.substring(1);o.hash(r),e(),0!==n().topMargin()&&setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-n().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<menu class="nav pagemenu"></menu>',link:function(t,o){n().setBuilder(function(){r(t,o)})}}}]),o.directive("pagemenuspy",["$location","$anchorScroll",function(){return{restrict:"A",link:function(t,o,e){n().addSpy({id:e.pagemenuspy,parent:e.parent,set:function(){o.addClass("active");var t=n().getSpy(this.parent);t&&t.set()},clear:function(){o.removeClass("active")}})}}}])}(angular);